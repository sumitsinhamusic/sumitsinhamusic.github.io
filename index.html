<script>
  // Library data
  const songs = [
    { title: "Adhuri Kahani", file: "Adhuri Kahani.mp3" },
    { title: "Junoon Hai Mere Khoon Mein", file: "Junoon Hai Mere Khoon Mein-Remix.wav" },
    { title: "Naam Tera Saanson Mein Hai", file: "Naam Tera Saanson Mein Hai.mp3" },
    { title: "Raaz Hai Tu Mere Wajood Mein", file: "Raaz Hai Tu Mere Wajood Mein.mp3" },
    // ... add more songs
  ];

  // Elements
  const globalPlayer = document.getElementById("globalPlayer");
  const nowTitle = document.getElementById("nowTitle");
  const pauseResumeBtn = document.getElementById("pauseResumeBtn");
  const playAllBtn = document.getElementById("playAllBtn");
  const popup = document.getElementById("popup");
  const allSongsList = document.getElementById("allSongs");
  const closePopupBtn = document.getElementById("closePopupBtn");

  // ----- PLAY SONG FUNCTION -----
  function loadAndPlay(file, title) {
    if (!file) return;

    // Update only ?song= without touching hash
    const url = new URL(window.location);
    url.searchParams.set("song", file);
    window.history.replaceState({}, "", url);

    // Stop if same song playing
    if (globalPlayer.src && globalPlayer.src.includes(file) && !globalPlayer.paused) {
      globalPlayer.pause();
      globalPlayer.currentTime = 0;
      nowTitle.textContent = "No song playing";
      pauseResumeBtn.disabled = true;
      return;
    }

    globalPlayer.src = file;
    globalPlayer.play().catch(() => {});
    nowTitle.textContent = title || file;
    pauseResumeBtn.disabled = false;
    pauseResumeBtn.textContent = "Pause";
  }

  // ----- LOAD SONG FROM URL ON PAGE LOAD -----
  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const songFile = params.get("song");
    if (songFile) {
      const song = songs.find(s => s.file === songFile);
      if (song) loadAndPlay(song.file, song.title);
    }
  });

  // ----- BIND SONG CARD BUTTONS -----
  document.querySelectorAll(".song-card .play-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const card = btn.closest(".song-card");
      loadAndPlay(card.dataset.file, card.dataset.title);
    });
  });

  // ----- PAUSE / RESUME -----
  pauseResumeBtn.addEventListener("click", () => {
    if (globalPlayer.paused) {
      globalPlayer.play();
      pauseResumeBtn.textContent = "Pause";
    } else {
      globalPlayer.pause();
      pauseResumeBtn.textContent = "Resume";
    }
  });

  // ----- PLAYBACK ENDED -----
  globalPlayer.addEventListener("ended", () => {
    nowTitle.textContent = "No song playing";
    pauseResumeBtn.disabled = true;
    pauseResumeBtn.textContent = "Pause";
  });

  // ----- POPUP LOGIC -----
  function openPopup() {
    allSongsList.innerHTML = "";
    songs.forEach(song => {
      const li = document.createElement("li");
      li.textContent = song.title;
      li.onclick = () => { loadAndPlay(song.file, song.title); closePopup(); };
      allSongsList.appendChild(li);
    });
    popup.classList.add("show");
    document.body.classList.add("popup-open");
  }
  function closePopup() {
    popup.classList.remove("show");
    document.body.classList.remove("popup-open");
  }
  playAllBtn.addEventListener("click", openPopup);
  closePopupBtn.addEventListener("click", closePopup);
  popup.addEventListener("click", e => { if(e.target === popup) closePopup(); });
  document.addEventListener("keydown", e => { if(e.key === "Escape" && popup.classList.contains("show")) closePopup(); });

  // ----- MENU LINKS UPDATE HASH ONLY -----
  document.querySelectorAll("header nav a").forEach(link => {
    link.addEventListener("click", e => {
      const hash = link.getAttribute("href"); // #about, #news etc.
      const url = new URL(window.location);
      url.hash = hash; // update only hash
      window.history.replaceState({}, "", url);
      // default scrolling behavior still works
    });
  });

  /* ===== MINI PLAYER DRAG LOGIC ===== */
  const mini = document.getElementById("nowPlayingBar");
  let isDragging = false, startX, startY, startLeft, startTop;

  function dragStart(e) {
    const targetTag = e.target.tagName;
    if(targetTag==="AUDIO"||targetTag==="BUTTON") return;
    isDragging = true;
    const rect = mini.getBoundingClientRect();
    startLeft = rect.left;
    startTop = rect.top;
    mini.style.right="auto";
    mini.style.bottom="auto";
    startX = e.type==="touchstart"?e.touches[0].clientX:e.clientX;
    startY = e.type==="touchstart"?e.touches[0].clientY:e.clientY;
    e.preventDefault();
  }
  function dragMove(e) {
    if(!isDragging) return;
    const clientX = e.type==="touchmove"?e.touches[0].clientX:e.clientX;
    const clientY = e.type==="touchmove"?e.touches[0].clientY:e.clientY;
    mini.style.left = startLeft + (clientX - startX) + "px";
    mini.style.top = startTop + (clientY - startY) + "px";
    e.preventDefault();
  }
  function dragEnd(){ isDragging=false; }

  mini.addEventListener("mousedown", dragStart);
  mini.addEventListener("touchstart", dragStart, {passive:false});
  document.addEventListener("mousemove", dragMove);
  document.addEventListener("touchmove", dragMove, {passive:false});
  document.addEventListener("mouseup", dragEnd);
  document.addEventListener("touchend", dragEnd);
</script>
